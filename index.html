<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹¤ì‹œê°„ ì¶”ì²¨/í˜¸ëª… ëª…ë‹¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div class="max-w-5xl mx-auto p-4 md:p-8 space-y-4">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-xl md:text-2xl font-bold">ì‹¤ì‹œê°„ ì¶”ì²¨/í˜¸ëª… ëª…ë‹¨</h1>
        <p class="text-sm text-slate-600">
          PC/ëª¨ë°”ì¼ì—ì„œ ë™ì‹œì— ì…ë ¥í•˜ë©´ ì¦‰ì‹œ ë™ê¸°í™”ë©ë‹ˆë‹¤.
          <span id="sessionLabel" class="font-medium"></span>
        </p>
      </div>

      <div class="flex gap-2 items-center flex-wrap">
        <button id="resultViewBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">
          ê²°ê³¼ ì „ì²´í™”ë©´
        </button>
        <button id="resetBtn" class="px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700">
          ì „ì²´ ì´ˆê¸°í™”(ìƒˆ ì„¸ì…˜)
        </button>
      </div>
    </header>

    <section class="bg-white rounded-2xl shadow-sm border p-4">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
        <div class="md:col-span-4">
          <label class="block text-sm font-medium mb-1">ì´ë¦„</label>
          <input id="nameInput" class="w-full px-3 py-2 rounded-lg border" placeholder="ì˜ˆ: í™ê¸¸ë™" />
        </div>
        <div class="md:col-span-4">
          <label class="block text-sm font-medium mb-1">ë²ˆí˜¸</label>
          <input id="numberInput" class="w-full px-3 py-2 rounded-lg border" placeholder="ì˜ˆ: 12 (001ë„ ê°€ëŠ¥)" />
        </div>
        <div class="md:col-span-4 flex gap-2">
          <button id="addBtn" class="flex-1 px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
            ëª…ë‹¨ ì¶”ê°€
          </button>
          <button id="quickClearBtn" class="px-3 py-2 rounded-lg border hover:bg-slate-50">
            ì…ë ¥ì¹¸ ë¹„ìš°ê¸°
          </button>
        </div>
      </div>

      <p id="status" class="text-sm text-slate-600 mt-3"></p>
    </section>

    <main class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <section class="bg-white rounded-2xl shadow-sm border overflow-hidden">
        <div class="p-4 border-b flex items-center justify-between">
          <h2 class="font-bold">ëŒ€ê¸° ëª…ë‹¨</h2>
          <span id="pendingCount" class="text-sm text-slate-600"></span>
        </div>
        <div class="max-h-[60vh] overflow-auto">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-slate-100">
              <tr>
                <th class="text-left p-2 w-16">ìˆœë²ˆ</th>

                <!-- âœ… ì •ë ¬ í´ë¦­ ê°€ëŠ¥ -->
                <th class="text-left p-2">
                  <button id="sortNameBtn" class="inline-flex items-center gap-1 font-semibold hover:underline">
                    ì´ë¦„ <span id="sortNameIcon" class="text-slate-500"></span>
                  </button>
                </th>

                <th class="text-left p-2 w-28">
                  <button id="sortNumberBtn" class="inline-flex items-center gap-1 font-semibold hover:underline">
                    ë²ˆí˜¸ <span id="sortNumberIcon" class="text-slate-500"></span>
                  </button>
                </th>

                <th class="text-left p-2 w-28">í˜¸ëª…</th>
              </tr>
            </thead>
            <tbody id="pendingTbody"></tbody>
          </table>
        </div>

        <!-- âœ… ìš”ì²­: ëŒ€ê¸° ëª…ë‹¨ ì•„ë˜ ë©”ëª¨ + ìŒì„±ë…¹ìŒ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€) -->
        <div class="border-t p-4 space-y-3">
          <div class="flex items-center justify-between gap-2">
            <h3 class="font-bold">ë©”ëª¨ / ìŒì„±ë…¹ìŒ</h3>
            <span id="recStatus" class="text-xs text-slate-500"></span>
          </div>

          <textarea id="memoText"
            class="w-full px-3 py-2 rounded-lg border text-sm"
            rows="3"
            placeholder="ì§„í–‰ ë©”ëª¨ë¥¼ ì ì–´ë‘ì„¸ìš” (í˜„ì¬ ê¸°ê¸° ë¡œì»¬ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤)"></textarea>

          <div class="flex flex-wrap gap-2 items-center">
            <button id="recordBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
              ğŸ™ ë…¹ìŒ ì‹œì‘
            </button>
            <button id="clearAudioBtn" class="px-3 py-2 rounded-lg border hover:bg-slate-50">
              ë…¹ìŒ ì‚­ì œ
            </button>

            <audio id="audioPlayer" controls class="w-full md:w-auto hidden"></audio>
          </div>

          <p class="text-xs text-slate-500">
            â€» ì•ˆë‚´: iPhone SafariëŠ” ë…¹ìŒ ê¶Œí•œ/ë™ì‘ì´ í™˜ê²½ì— ë”°ë¼ ì œí•œë  ìˆ˜ ìˆì–´ìš”. (Chrome/AndroidëŠ” ëŒ€ë¶€ë¶„ ì˜ ë™ì‘)
          </p>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow-sm border overflow-hidden">
        <div class="p-4 border-b flex items-center justify-between">
          <h2 class="font-bold">ì™„ë£Œ ëª…ë‹¨</h2>
          <span id="doneCount" class="text-sm text-slate-600"></span>
        </div>
        <div class="max-h-[60vh] overflow-auto">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-slate-100">
              <tr>
                <th class="text-left p-2 w-16">ìˆœë²ˆ</th>
                <th class="text-left p-2">ì´ë¦„</th>
                <th class="text-left p-2 w-28">ë²ˆí˜¸</th>
                <th class="text-left p-2 w-28">ì·¨ì†Œ</th>
              </tr>
            </thead>
            <tbody id="doneTbody"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- âœ… ê²°ê³¼ ì „ì²´í™”ë©´ ì˜¤ë²„ë ˆì´ (ì´ë¦„/ë²ˆí˜¸ë§Œ í¬ê²Œ) -->
  <div id="resultOverlay" class="fixed inset-0 bg-black/90 text-white hidden z-50">
    <div class="h-full flex flex-col">
      <div class="p-3 md:p-4 flex items-center justify-between border-b border-white/10">
        <div class="text-sm md:text-base opacity-90">
          ê²°ê³¼ í™”ë©´ Â· ì‹¤ì‹œê°„ ì—°ë™
          <span id="resultSessionLabel" class="ml-2 font-semibold"></span>
        </div>
        <div class="flex gap-2">
          <button id="resultSortNameBtn" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20">
            ì´ë¦„ ì •ë ¬
          </button>
          <button id="resultSortNumberBtn" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20">
            ë²ˆí˜¸ ì •ë ¬
          </button>
          <button id="exitResultBtn" class="px-3 py-2 rounded-lg bg-rose-500 hover:bg-rose-600">
            ë‹«ê¸°
          </button>
        </div>
      </div>

      <div class="flex-1 overflow-auto p-3 md:p-6">
        <div id="resultGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4"></div>
      </div>

      <div class="p-3 md:p-4 text-xs md:text-sm opacity-80 border-t border-white/10">
        íŒ: ì´ë¦„/ë²ˆí˜¸ ì •ë ¬ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì˜¤ë¦„â†”ë‚´ë¦¼ í† ê¸€ë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <script type="module">
    // ===== Firebase SDK (ëª¨ë“ˆ) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, serverTimestamp,
      collection, addDoc, onSnapshot, query, orderBy, updateDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // 1) Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDEsSa0HwIZ44HWez0oOTtuNRvnX_eVU9U",
      authDomain: "pick-gift.firebaseapp.com",
      projectId: "pick-gift",
      storageBucket: "pick-gift.firebasestorage.app",
      messagingSenderId: "372503045664",
      appId: "1:372503045664:web:b6d31074c9dee9a6dffe45",
      measurementId: "G-Y5N46XNLH2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== UI =====
    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const sessionLabelEl = $("sessionLabel");
    const pendingTbody = $("pendingTbody");
    const doneTbody = $("doneTbody");
    const pendingCountEl = $("pendingCount");
    const doneCountEl = $("doneCount");

    const sortNameBtn = $("sortNameBtn");
    const sortNumberBtn = $("sortNumberBtn");
    const sortNameIcon = $("sortNameIcon");
    const sortNumberIcon = $("sortNumberIcon");

    // Result overlay UI
    const resultOverlay = $("resultOverlay");
    const resultViewBtn = $("resultViewBtn");
    const exitResultBtn = $("exitResultBtn");
    const resultGrid = $("resultGrid");
    const resultSessionLabel = $("resultSessionLabel");
    const resultSessionLabelTop = $("resultSessionLabel");
    const resultSortNameBtn = $("resultSortNameBtn");
    const resultSortNumberBtn = $("resultSortNumberBtn");

    // Memo/Record UI
    const memoText = $("memoText");
    const recordBtn = $("recordBtn");
    const clearAudioBtn = $("clearAudioBtn");
    const audioPlayer = $("audioPlayer");
    const recStatus = $("recStatus");

    function setStatus(msg) { statusEl.textContent = msg || ""; }

    function safeText(s) {
      return (s ?? "").toString().replace(/[<>&"]/g, (c) => ({
        "<":"&lt;", ">":"&gt;", "&":"&amp;", '"':"&quot;"
      }[c]));
    }

    // âœ… ë²ˆí˜¸ ì •ê·œí™”: "001" -> "1", "01" -> "1"
    function normalizeNumber(num) {
      const t = String(num ?? "").trim();
      if (t === "") return "";
      const n = Number(t);
      if (Number.isNaN(n)) return t;
      return String(Math.trunc(n));
    }

    function nameKey(name) {
      return String(name ?? "").trim().toLocaleLowerCase("ko");
    }
    function numberKey(num) {
      const n = Number(normalizeNumber(num));
      return Number.isNaN(n) ? Infinity : n;
    }

    // ===== ì •ë ¬ ìƒíƒœ =====
    const sortState = { sortBy: "created", sortDir: "asc" };

    function setSort(by) {
      if (sortState.sortBy === by) {
        sortState.sortDir = (sortState.sortDir === "asc") ? "desc" : "asc";
      } else {
        sortState.sortBy = by;
        sortState.sortDir = "asc";
      }
      updateSortIcons();
      renderTableRows(cachedEntries);
      renderResultView(cachedEntries);
    }

    function updateSortIcons() {
      sortNameIcon.textContent = "";
      sortNumberIcon.textContent = "";
      if (sortState.sortBy === "name") sortNameIcon.textContent = (sortState.sortDir === "asc" ? "â–²" : "â–¼");
      if (sortState.sortBy === "number") sortNumberIcon.textContent = (sortState.sortDir === "asc" ? "â–²" : "â–¼");
    }

    function compareEntries(a, b) {
      const dir = (sortState.sortDir === "asc") ? 1 : -1;

      if (sortState.sortBy === "name") {
        const aa = nameKey(a.name);
        const bb = nameKey(b.name);
        if (aa < bb) return -1 * dir;
        if (aa > bb) return  1 * dir;
        return (numberKey(a.number) - numberKey(b.number)) * dir;
      }

      if (sortState.sortBy === "number") {
        const aa = numberKey(a.number);
        const bb = numberKey(b.number);
        if (aa !== bb) return (aa - bb) * dir;
        const na = nameKey(a.name);
        const nb = nameKey(b.name);
        if (na < nb) return -1 * dir;
        if (na > nb) return  1 * dir;
        return 0;
      }

      const ta = a.createdAt?.seconds ?? 0;
      const tb = b.createdAt?.seconds ?? 0;
      if (ta !== tb) return (ta - tb);
      return 0;
    }

    // ===== ë°ì´í„° êµ¬ì¡° =====
    const stateRef = doc(db, "app", "state");
    let currentSessionId = null;
    let unsubscribeEntries = null;

    // âœ… entries ìºì‹œ (ì¤‘ë³µ ì²´í¬/ì¬ë Œë”/ì •ë ¬)
    let cachedEntries = [];

    async function ensureState() {
      const snap = await getDoc(stateRef);
      if (!snap.exists() || !snap.data()?.currentSessionId) {
        const newId = crypto.randomUUID();
        await setDoc(doc(db, "sessions", newId), { createdAt: serverTimestamp() });
        await setDoc(stateRef, { currentSessionId: newId, updatedAt: serverTimestamp() });
      }
    }

    function renderTableRows(entries) {
      const pending = [];
      const done = [];
      entries.forEach(e => (e.called ? done : pending).push(e));

      const pendingSorted = pending.slice().sort(compareEntries);
      const doneSorted = done.slice().sort(compareEntries);

      pendingTbody.innerHTML = pendingSorted.map((e, idx) => `
        <tr class="border-b last:border-b-0">
          <td class="p-2 text-slate-500">${idx + 1}</td>
          <td class="p-2 font-medium">${safeText(e.name)}</td>
          <td class="p-2">${safeText(e.number)}</td>
          <td class="p-2">
            <button data-id="${e.id}" class="callBtn px-2 py-1 rounded-md bg-emerald-600 text-white hover:bg-emerald-700">
              ì™„ë£Œ
            </button>
          </td>
        </tr>
      `).join("");

      doneTbody.innerHTML = doneSorted.map((e, idx) => `
        <tr class="border-b last:border-b-0 opacity-90">
          <td class="p-2 text-slate-500">${idx + 1}</td>
          <td class="p-2 font-medium line-through">${safeText(e.name)}</td>
          <td class="p-2 line-through">${safeText(e.number)}</td>
          <td class="p-2">
            <button data-id="${e.id}" class="undoBtn px-2 py-1 rounded-md border hover:bg-slate-50">
              ë˜ëŒë¦¬ê¸°
            </button>
          </td>
        </tr>
      `).join("");

      pendingCountEl.textContent = `ì´ ${pending.length}ëª…`;
      doneCountEl.textContent = `ì´ ${done.length}ëª…`;

      wireRowButtons();
    }

    function renderResultView(entries) {
      if (resultOverlay.classList.contains("hidden")) return;

      const pendingOnly = entries.filter(e => !e.called);
      const sorted = pendingOnly.slice().sort(compareEntries);

      resultGrid.innerHTML = sorted.map((e) => `
        <div class="rounded-2xl bg-white/10 border border-white/10 p-4 md:p-5">
          <div class="text-2xl md:text-4xl font-extrabold tracking-tight">
            ${safeText(e.name)}
          </div>
          <div class="mt-2 text-xl md:text-3xl font-bold opacity-90">
            ${safeText(e.number)}
          </div>
        </div>
      `).join("");
    }

    function wireRowButtons() {
      pendingTbody.querySelectorAll(".callBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          await updateDoc(doc(db, "sessions", currentSessionId, "entries", id), {
            called: true,
            calledAt: serverTimestamp()
          });
        });
      });
      doneTbody.querySelectorAll(".undoBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          await updateDoc(doc(db, "sessions", currentSessionId, "entries", id), {
            called: false,
            calledAt: null
          });
        });
      });
    }

    function subscribeEntries(sessionId) {
      if (unsubscribeEntries) unsubscribeEntries();

      const entriesRef = collection(db, "sessions", sessionId, "entries");
      const q = query(entriesRef, orderBy("createdAt", "asc"));

      unsubscribeEntries = onSnapshot(q, (snap) => {
        const entries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        cachedEntries = entries;

        renderTableRows(entries);
        renderResultView(entries);

        setStatus(`ì—°ê²°ë¨ Â· ì„¸ì…˜ ${sessionId.slice(0, 8)} Â· ${new Date().toLocaleString()}`);
      }, (err) => {
        console.error(err);
        setStatus("ì˜¤ë¥˜: Firestore ì—°ê²° ì‹¤íŒ¨. ê·œì¹™/ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      });
    }

    async function createNewSessionAndSwitch() {
      const newId = crypto.randomUUID();
      await setDoc(doc(db, "sessions", newId), { createdAt: serverTimestamp() });
      await setDoc(stateRef, { currentSessionId: newId, updatedAt: serverTimestamp() }, { merge: true });
    }

    // ===== ê¸°ì¡´ ì´ë²¤íŠ¸ =====
    $("addBtn").addEventListener("click", async () => {
      const name = $("nameInput").value.trim();
      const rawNumber = $("numberInput").value.trim();

      if (!name || !rawNumber) {
        alert("ì´ë¦„/ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const number = normalizeNumber(rawNumber);

      const isDuplicate = cachedEntries.some(e =>
        (e.name ?? "").trim() === name &&
        normalizeNumber(e.number) === number
      );

      if (isDuplicate) {
        alert("ì´ë¯¸ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
      }

      const entriesRef = collection(db, "sessions", currentSessionId, "entries");
      await addDoc(entriesRef, {
        name,
        number,
        called: false,
        createdAt: serverTimestamp(),
        calledAt: null,
      });

      $("nameInput").value = "";
      $("numberInput").value = "";
      $("nameInput").focus();
    });

    $("quickClearBtn").addEventListener("click", () => {
      $("nameInput").value = "";
      $("numberInput").value = "";
      $("nameInput").focus();
    });

    $("resetBtn").addEventListener("click", async () => {
      const ok = confirm("ì •ë§ 'ì „ì²´ ì´ˆê¸°í™”(ìƒˆ ì„¸ì…˜)' í• ê¹Œìš”?\n(ê¸°ì¡´ ë°ì´í„°ëŠ” ì‚­ì œë˜ì§€ ì•Šê³ , ìƒˆ ëª…ë‹¨ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.)");
      if (!ok) return;
      await createNewSessionAndSwitch();
    });

    // ì •ë ¬ ë²„íŠ¼
    sortNameBtn.addEventListener("click", () => setSort("name"));
    sortNumberBtn.addEventListener("click", () => setSort("number"));

    // ê²°ê³¼ ì „ì²´í™”ë©´
    resultViewBtn.addEventListener("click", async () => {
      const el = resultOverlay;
      el.classList.remove("hidden");
      resultSessionLabel.textContent = currentSessionId ? `Â· ${currentSessionId.slice(0, 8)}` : "";
      try { if (el.requestFullscreen) await el.requestFullscreen(); } catch (_) {}
      renderResultView(cachedEntries);
    });

    resultSortNameBtn.addEventListener("click", () => setSort("name"));
    resultSortNumberBtn.addEventListener("click", () => setSort("number"));

    exitResultBtn.addEventListener("click", async () => {
      resultOverlay.classList.add("hidden");
      try { if (document.fullscreenElement) await document.exitFullscreen(); } catch (_) {}
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !resultOverlay.classList.contains("hidden")) {
        exitResultBtn.click();
      }
    });

    // ===== âœ… ì¶”ê°€: ë©”ëª¨ ë¡œì»¬ ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ìœ ì§€) =====
    // ì„¸ì…˜ë³„ë¡œ ë©”ëª¨ë¥¼ ë”°ë¡œ ì €ì¥
    function memoKey(sessionId) { return `memo_${sessionId}`; }
    function audioKey(sessionId) { return `audio_${sessionId}`; }

    function loadMemo() {
      if (!currentSessionId) return;
      const saved = localStorage.getItem(memoKey(currentSessionId));
      if (saved != null) memoText.value = saved;
    }
    function saveMemo() {
      if (!currentSessionId) return;
      localStorage.setItem(memoKey(currentSessionId), memoText.value ?? "");
    }
    memoText.addEventListener("input", () => saveMemo());

    // ===== âœ… ì¶”ê°€: ìŒì„± ë…¹ìŒ (ê¸°ê¸° ë¡œì»¬) =====
    let recorder = null;
    let chunks = [];
    let currentStream = null;

    function setRecStatus(text) { recStatus.textContent = text || ""; }

    function stopTracks() {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
    }

    async function startRecording() {
      if (!navigator.mediaDevices?.getUserMedia) {
        alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ë…¹ìŒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      currentStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(currentStream);
      chunks = [];

      recorder.ondataavailable = (e) => { if (e.data?.size) chunks.push(e.data); };
      recorder.onstop = async () => {
        stopTracks();
        const blob = new Blob(chunks, { type: recorder.mimeType || "audio/webm" });
        const url = URL.createObjectURL(blob);
        audioPlayer.src = url;
        audioPlayer.classList.remove("hidden");

        // âœ… ë¡œì»¬ ì €ì¥(ë¸Œë¼ìš°ì €ì— ë”°ë¼ ìš©ëŸ‰ ì œí•œ ìˆìŒ) - ì›ì¹˜ ì•Šìœ¼ë©´ ì œê±° ê°€ëŠ¥
        if (currentSessionId) {
          try {
            const base64 = await blobToBase64(blob);
            localStorage.setItem(audioKey(currentSessionId), base64);
          } catch (e) {
            // ìš©ëŸ‰ ì´ˆê³¼ ì‹œ ì €ì¥ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ
            console.warn("ì˜¤ë””ì˜¤ ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨(ìš©ëŸ‰ ì œí•œ ê°€ëŠ¥):", e);
          }
        }

        setRecStatus("ë…¹ìŒ ì™„ë£Œ");
        recordBtn.textContent = "ğŸ™ ë…¹ìŒ ì‹œì‘";
      };

      recorder.start();
      setRecStatus("ë…¹ìŒ ì¤‘...");
      recordBtn.textContent = "â¹ ë…¹ìŒ ì¤‘ì§€";
    }

    function stopRecording() {
      if (recorder && recorder.state === "recording") {
        recorder.stop();
      }
    }

    recordBtn.addEventListener("click", async () => {
      try {
        if (!recorder || recorder.state === "inactive") {
          await startRecording();
        } else if (recorder.state === "recording") {
          stopRecording();
        }
      } catch (err) {
        console.error(err);
        setRecStatus("ë…¹ìŒ ì‹¤íŒ¨(ê¶Œí•œ/ë¸Œë¼ìš°ì € í™•ì¸)");
        recordBtn.textContent = "ğŸ™ ë…¹ìŒ ì‹œì‘";
        stopTracks();
      }
    });

    clearAudioBtn.addEventListener("click", () => {
      audioPlayer.pause();
      audioPlayer.src = "";
      audioPlayer.classList.add("hidden");
      setRecStatus("");

      if (currentSessionId) {
        localStorage.removeItem(audioKey(currentSessionId));
      }
    });

    async function blobToBase64(blob) {
      return await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = reject;
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    function loadAudio() {
      if (!currentSessionId) return;
      const saved = localStorage.getItem(audioKey(currentSessionId));
      if (!saved) return;
      audioPlayer.src = saved;
      audioPlayer.classList.remove("hidden");
      setRecStatus("ì €ì¥ëœ ë…¹ìŒ ë¶ˆëŸ¬ì˜´");
    }

    // ===== ì‹œì‘ =====
    setStatus("ë¡œê·¸ì¸/ì—°ê²° ì¤‘...");
    await signInAnonymously(auth);
    await ensureState();

    onSnapshot(stateRef, (snap) => {
      const data = snap.data();
      if (!data?.currentSessionId) return;

      const nextSessionId = data.currentSessionId;
      if (nextSessionId !== currentSessionId) {
        currentSessionId = nextSessionId;
        sessionLabelEl.textContent = `Â· í˜„ì¬ ì„¸ì…˜: ${currentSessionId.slice(0, 8)}`;
        resultSessionLabel.textContent = `Â· ${currentSessionId.slice(0, 8)}`;

        // âœ… ì„¸ì…˜ ë°”ë€Œë©´ ë©”ëª¨/ì˜¤ë””ì˜¤ë„ í•´ë‹¹ ì„¸ì…˜ ê²ƒìœ¼ë¡œ ë¡œë”©
        loadMemo();
        loadAudio();

        subscribeEntries(currentSessionId);
      }
    });

    updateSortIcons();
  </script>
</body>
</html>
