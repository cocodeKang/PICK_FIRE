<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹¤ì‹œê°„ ì¶”ì²¨/í˜¸ëª… ëª…ë‹¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div class="max-w-4xl mx-auto p-3 md:p-6 space-y-4">

    <!-- í—¤ë” -->
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-lg md:text-2xl font-bold">ëŒ€ê¸° ëª…ë‹¨ (ì „ì²´ ë³´ê¸°)</h1>
        <p class="text-xs md:text-sm text-slate-600">
          ì‹¤ì‹œê°„ ë™ê¸°í™” Â· ì´ë¦„/ë²ˆí˜¸ ì •ë ¬ ê°€ëŠ¥
        </p>
      </div>
      <button id="resetBtn" class="px-3 py-2 rounded bg-rose-600 text-white">
        ì „ì²´ ì´ˆê¸°í™”
      </button>
    </header>

    <!-- ì •ë ¬ ë²„íŠ¼ -->
    <div class="flex gap-2 text-sm">
      <button id="sortNameBtn" class="px-3 py-2 rounded bg-slate-200">
        ì´ë¦„ ì •ë ¬
      </button>
      <button id="sortNumberBtn" class="px-3 py-2 rounded bg-slate-200">
        ë²ˆí˜¸ ì •ë ¬
      </button>
      <span id="pendingCount" class="ml-auto text-slate-600"></span>
    </div>

    <!-- ëŒ€ê¸° ëª…ë‹¨ (ì „ì²´ ëª…ë‹¨ ëŠë‚Œ) -->
    <section class="bg-white rounded-xl border shadow-sm">
      <div id="pendingList" class="divide-y">
        <!-- JSë¡œ ë Œë”ë§ -->
      </div>
    </section>

    <!-- ë©”ëª¨ì¥ -->
    <section class="bg-white rounded-xl border shadow-sm p-3 space-y-3">
      <h2 class="font-bold">ğŸ“ ë©”ëª¨ / ğŸ™ ìŒì„±ë…¹ìŒ</h2>

      <textarea id="memoText"
        class="w-full border rounded p-2 text-sm"
        rows="3"
        placeholder="ì§„í–‰ ì¤‘ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>

      <div class="flex gap-2 items-center">
        <button id="recordBtn" class="px-3 py-2 rounded bg-indigo-600 text-white">
          ğŸ™ ë…¹ìŒ ì‹œì‘
        </button>
        <audio id="audioPlayer" controls class="hidden"></audio>
      </div>
    </section>

  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, serverTimestamp,
  collection, addDoc, onSnapshot, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyDEsSa0HwIZ44HWez0oOTtuNRvnX_eVU9U",
  authDomain: "pick-gift.firebaseapp.com",
  projectId: "pick-gift",
  storageBucket: "pick-gift.firebasestorage.app",
  messagingSenderId: "372503045664",
  appId: "1:372503045664:web:b6d31074c9dee9a6dffe45",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
await signInAnonymously(auth);

/* ìƒíƒœ */
let cachedEntries = [];
let sortBy = "created";
let sortDir = "asc";

/* ì •ë ¬ */
function compare(a, b) {
  const dir = sortDir === "asc" ? 1 : -1;
  if (sortBy === "name") return a.name.localeCompare(b.name, "ko") * dir;
  if (sortBy === "number") return (Number(a.number) - Number(b.number)) * dir;
  return 0;
}

/* ë Œë” */
function render() {
  const list = cachedEntries
    .filter(e => !e.called)
    .slice()
    .sort(compare);

  document.getElementById("pendingCount").textContent =
    `ì´ ${list.length}ëª…`;

  document.getElementById("pendingList").innerHTML = list.map(e => `
    <div class="p-3 flex items-center gap-4">
      <div class="text-2xl font-bold w-32">${e.name}</div>
      <div class="text-xl text-slate-600">${e.number}</div>
    </div>
  `).join("");
}

/* Firestore êµ¬ë… */
const stateRef = doc(db, "app", "state");
const snap = await getDoc(stateRef);
let sessionId = snap.data().currentSessionId;

onSnapshot(
  query(collection(db, "sessions", sessionId, "entries"), orderBy("createdAt")),
  s => {
    cachedEntries = s.docs.map(d => d.data());
    render();
  }
);

/* ì •ë ¬ ë²„íŠ¼ */
sortNameBtn.onclick = () => {
  sortBy === "name" ? sortDir = (sortDir === "asc" ? "desc" : "asc") : (sortBy = "name", sortDir = "asc");
  render();
};
sortNumberBtn.onclick = () => {
  sortBy === "number" ? sortDir = (sortDir === "asc" ? "desc" : "asc") : (sortBy = "number", sortDir = "asc");
  render();
};

/* ìŒì„± ë…¹ìŒ */
let recorder, chunks = [];
recordBtn.onclick = async () => {
  if (!recorder || recorder.state === "inactive") {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);
    chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: "audio/webm" });
      audioPlayer.src = URL.createObjectURL(blob);
      audioPlayer.classList.remove("hidden");
    };
    recorder.start();
    recordBtn.textContent = "â¹ ë…¹ìŒ ì¤‘ì§€";
  } else {
    recorder.stop();
    recordBtn.textContent = "ğŸ™ ë…¹ìŒ ì‹œì‘";
  }
};
</script>
</body>
</html>
